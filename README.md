# **日本网络拓扑恢复**
本项目记录了恢复日本网络拓扑的过程。先展示一下各个阶段的效果。
*********

1、原始数据画出的日本网络拓扑图。
![1](https://github.com/Mr-whoz/picture/raw/master/%E6%97%A5%E6%9C%AC%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E6%81%A2%E5%A4%8D/%E5%8E%9F%E5%A7%8B%E6%95%B0%E6%8D%AE.png)
2、初步筛选之后的拓扑
![2](https://raw.githubusercontent.com/Mr-whoz/picture/master/%E6%97%A5%E6%9C%AC%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E6%81%A2%E5%A4%8D/%E5%88%9D%E6%AD%A5%E7%AD%9B%E9%80%89.png)
3、处理完全之后的整体效果图
![3](https://github.com/Mr-whoz/picture/raw/master/%E6%97%A5%E6%9C%AC%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E6%81%A2%E5%A4%8D/%E5%A4%84%E7%90%86%E4%B9%8B%E5%90%8E%E7%9A%84%E6%95%B4%E4%BD%93%E6%95%88%E6%9E%9C%E5%9B%BE.png)
4、整体效果图中东京的细节展示
![4](https://github.com/Mr-whoz/picture/raw/master/%E6%97%A5%E6%9C%AC%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91%E6%81%A2%E5%A4%8D/%E4%B8%9C%E4%BA%AC%E7%9A%84%E6%95%88%E6%9E%9C%E5%9B%BE.png)
*********
###### 描述

做的主要是拓扑恢复。主要目标是日本网络。最后要可视化在googleearth上，直示日本的拓扑结构。

**网络爬虫**：所以就要用到ip的地理位置。刚开始是找到一个网站，提供ip定位的查询。分配给日本的ip段有2亿多个ip。这么多ip不可能手动去查，所以就想到写网络爬虫，然后存到数据库里。由于这个网站是国外的，访问有点慢，2亿个ip得花一个多月才能爬完。所以就用了多线程。采用生产者消费者模式完成了这个爬虫。生产者是日本ip段，不断向队列里put ip，消费者是70个左右的线程，每爬完一个ip，就从队列里get一个ip出来继续爬。用锁进行的互斥。因为网页有一个robot协议，在一段时间访问过多之后会屏蔽你一段时间。所以当请求出错时，我会sleep一段时间，再次请求。当时考虑过ip代理池，但是老师催的紧，这个又可以运行，就没有继续研究。因为消费者的消费速度远小于生产者的生产速度，所以判断程序完成任务的标志就是：当消费者从队列里面取数据时，设置超时时间10分钟，10分钟还取不到数据，说明所有数据爬完，停止线程。然后由于ip地址一个子网定位基本一样，所以我256个ip为一个请求，这样下来两天就爬完了日本2亿个ip。然而后来发现有几个ip定位免费数据库，就下载下来用的人家提供的数据。。。所以说这方面有了点歪路

**对日本网络进行恢复**:我们分了三层来进行恢复。是细节网络，主要展现网络的连接关系。第二层是整体脉络，主要展现日本整体的主干连接关系。第三层是在第二层的基础上再精炼，展现日本的几个主要网络节点。**第一层**：因为很多ip的定位都一样，导致很多节点都聚集在一起，比如说，东京一个很小的范围内就有4000个节点以上。如何把这几千个点无交叉的展现就是一个问题。我用的是力导引算法，因为这么多节点有没有交叉混乱的穿插在一起，是不能用指标来说明的，必须用眼看，所以，我用qt实现了一个系统，可以控制力导引的迭代次数，当迭代的时候，这个图会动态变化，当变化到你认为清晰的一个程度后可以暂停，将图的数据保存下来，然后将保存的数据再通过计算映射到谷歌地球上，用这个方法将日本的主要大城市做了处理，有30个左右。然后由于网络连接程度太高，依旧不清晰，而且这一层不太重要，所以为了美观，进行了二次处理。用point in polygen算法取出某个城市的点边连接关系，然后用bfs生成树算法生成一棵树，再对树进行力导引，然后映射到地图上，这样最后的结果就比较好看了。**第二层**：因为ip定位不是很准，数据的子网划分也可能有错误，所以整个日本的拓扑就像一个线团一样，非常混乱，根本看不出脉络走向。所以主要任务就是取其精华去其糟粕。怎么取呢。我加了很多规则和假设。比如说，一个节点的出入度很高，有几千，那么他大概率定位没有错，应该保留，否则，如果一个节点出入度只有个位数的话，那么很有可能定位错了，应该删除，同时与这个点相邻的边也应该删除。这样就删除了很大一部分边，就清晰了很多。然后，第二个规则，边太长的应该删除，比如说，一条边从日本最北边的北海道连到了日本最南边的冲绳，肯定是有问题的，因为他肯定会经过日本中间的大板等城市。所以这些边应该也去处，最后整个图就很清晰了，可以看到日本的网络是沿海而布的，内陆的网络很稀疏。**第三层**：就是第二层的再简化，思路基本相同。

*******************

代码结构
Tokyo_logistic_topo/kml_tool.py主要写了KML的生成规则，方便我们对数据的可视化。
Tokyo_logistic_topo/Tokyo_logic.py主要写了数据的处理过程。
这两个为主要逻辑代码，其余代码为对中间数据的加工代码。
利用的数据为CAIDA提供的数据，官网上可以下载。
